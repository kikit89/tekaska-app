<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moj Planer 6.3.1</title>
    <style>
        /* --- 1. OSNOVA --- */
        :root { --bg: #f4f7f6; --white: #fff; --grey: #bdc3c7; --dark: #2c3e50; --green: #27ae60; --red: #c0392b; --orange: #e67e22; --purple: #8e44ad; --blue: #3498db; }
        html { height: 100%; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 0; padding-bottom: 75px; min-height: 100%; color: #333; -webkit-user-select: none; user-select: none; }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--bg); }
        h1 { margin: 0; color: var(--dark); font-size: 1.4rem; text-transform: uppercase; letter-spacing: 1px; }
        .view-btn { background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--white); border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { text-align: center; flex: 1; color: #95a5a6; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--dark); font-weight: bold; }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
        .page { display: none; padding: 10px; animation: fadeIn 0.2s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* KOLEDAR */
        .calendar-wrap { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); background: #f8f9fa; border-bottom: 1px solid #eee; }
        .day-name { text-align: center; font-weight: bold; padding: 8px 0; font-size: 0.7rem; color: #7f8c8d; }
        .calendar-body { display: grid; grid-template-columns: repeat(7, 1fr); background: #eee; gap: 1px; }
        .day-cell { background: var(--white); min-height: 85px; position: relative; cursor: pointer; display: flex; flex-direction: column; align-items: center; padding-top: 24px; overflow: hidden; }
        .day-num { position: absolute; top: 4px; left: 4px; font-weight: bold; color: #bdc3c7; font-size: 0.8rem; }
        
        /* LIST VIEW SPECIFICS */
        .mode-list .calendar-header { display: none; }
        .mode-list .calendar-body { display: flex; flex-direction: column; }
        .mode-list .day-cell { flex-direction: row; padding: 15px; min-height: auto; align-items: flex-start; }
        .day-left-col { width: 50px; border-right: 1px solid #eee; margin-right: 10px; }
        .day-weekday { font-size: 0.6rem; color: #999; }

        .dots-wrap { display: flex; flex-direction: column; gap: 2px; width: 100%; }
        .dot-row, .list-row { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; }
        .dot { width: 8px; height: 8px; border-radius: 50%; border: 1.5px solid transparent; }
        
        /* PROGRESS & UI */
        .progress-section { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .sec-title { text-align: center; font-weight: bold; margin-bottom: 15px; }
        .bar-group { margin-bottom: 10px; }
        .bar-track { background: #eee; height: 8px; border-radius: 4px; position: relative; margin: 5px 0; }
        .bar-fill { height: 100%; border-radius: 4px; }
        .bar-marker { position: absolute; top: 0; width: 2px; height: 100%; background: #000; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 85%; padding: 20px; border-radius: 15px; }
        .inp-group { margin-bottom: 10px; }
        .inp-group input, .inp-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .modal-btns { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .type-selector { display: flex; gap: 5px; margin-bottom: 15px; }
        .type-opt { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-size: 1.2rem; }
        .type-opt.selected { background: #e8f5e9; border-color: var(--green); }
        
        .goal-list-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .backup-area { background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>

    <div id="tab-calendar" class="page active">
        <div class="header-row"><h1>Koledar</h1><button class="view-btn" onclick="toggleViewMode()" id="viewBtn">üìú</button></div>
        <div id="calendarWrap" class="calendar-wrap mode-grid">
            <div class="calendar-header"><div class="day-name">PO</div><div class="day-name">TO</div><div class="day-name">SR</div><div class="day-name">ƒåE</div><div class="day-name">PE</div><div class="day-name">SO</div><div class="day-name">NE</div></div>
            <div id="calendarBody" class="calendar-body"></div>
        </div>
        <div id="progressSection" class="progress-section"></div>
    </div>

    <div id="tab-analytics" class="page">
        <div class="header-row"><h1>Analiza</h1></div>
        <div class="stat-grid">
            <div class="stat-card"><span id="statMaxDist" class="stat-val">0.0 km</span><br><small>Najdalj≈°i tek</small></div>
            <div class="stat-card"><span id="statMaxElev" class="stat-val">0 m</span><br><small>Najveƒç vi≈°incev</small></div>
        </div>
        <div class="progress-section" style="margin-top:15px;">
            <div class="sec-title">Razmerje Aktivnosti</div>
            <div style="display:flex; justify-content:center;"><div id="activityPie" style="width:150px; height:150px; border-radius:50%;"></div></div>
        </div>
    </div>

    <div id="tab-races" class="page">
        <div class="header-row"><h1>Tekme</h1></div>
        <div id="myRacesList" class="progress-section"></div>
        <button class="btn" style="background:var(--green); color:white; width:100%;" onclick="openRaceModal()">‚ûï Dodaj tekmo</button>
    </div>

    <div id="tab-settings" class="page">
        <div class="header-row"><h1>Nastavitve</h1></div>
        <div class="backup-area">
            <button class="btn" style="background:var(--blue); color:white; width:100%; margin-bottom:10px;" onclick="downloadBackup()">üì• Shrani na telefon (Backup)</button>
            <button class="btn" style="background:var(--orange); color:white; width:100%;" onclick="document.getElementById('fileInput').click()">üì§ Nalo≈æi podatke</button>
            <input type="file" id="fileInput" style="display:none" onchange="handleFileUpload(this)">
        </div>
        <div id="settingsList" class="progress-section" style="margin-top:15px;"></div>
        <button class="btn" style="background:var(--green); color:white; width:100%;" onclick="openGoalModal()">‚ûï Dodaj nov cilj</button>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="goTab('calendar')"><span class="nav-icon">üìä</span> Koledar</div>
        <div class="nav-item" onclick="goTab('analytics')"><span class="nav-icon">üìà</span> Analiza</div>
        <div class="nav-item" onclick="goTab('races')"><span class="nav-icon">üèÜ</span> Tekme</div>
        <div class="nav-item" onclick="goTab('settings')"><span class="nav-icon">‚öôÔ∏è</span> Nastavitve</div>
    </div>

    <div id="entryModal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="modalDateTitle">Vnos</h2>
            <div class="type-selector">
                <div class="type-opt selected" onclick="selectType('run', this)">üèÉ‚Äç‚ôÄÔ∏è</div>
                <div class="type-opt" onclick="selectType('bike', this)">üö¥‚Äç‚ôÄÔ∏è</div>
                <div class="type-opt" onclick="selectType('hike', this)">‚õ∞Ô∏è</div>
                <div class="type-opt" onclick="selectType('other', this)">üèä</div>
            </div>
            <input type="hidden" id="inpType" value="run">
            <div class="inp-group"><label>Razdalja (km)</label><input type="number" id="inpRun" step="0.01"></div>
            <div class="inp-group"><label>Vi≈°inci (m)</label><input type="number" id="inpElev" step="1"></div>
            <div class="modal-btns"><button class="btn" onclick="closeModal('entryModal')">Zapri</button><button class="btn" style="background:var(--green);color:white;" onclick="saveData()">Shrani</button></div>
        </div>
    </div>

    <div id="addGoalModal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="goalModalTitle">Cilj</h2>
            <div class="inp-group"><input type="text" id="newGoalName" placeholder="Ime cilja"></div>
            <div class="inp-group"><input type="number" id="newGoalTarget" placeholder="Vrednost"></div>
            <div class="inp-group"><select id="newGoalUnit"><option value="km">km</option><option value="m">m</option></select></div>
            <div class="inp-group"><select id="newGoalType"><option value="Letni">Letni</option><option value="Mesecni">Meseƒçni</option></select></div>
            <div class="inp-group"><input type="color" id="newGoalColor"></div>
            <div class="modal-btns"><button class="btn" onclick="closeModal('addGoalModal')">Zapri</button><button class="btn" style="background:var(--green);color:white;" id="goalModalBtn" onclick="saveGoalFromModal()">Shrani</button></div>
        </div>
    </div>

    <div id="addRaceModal" class="modal-overlay">
        <div class="modal-box">
            <h2>Nova Tekma</h2>
            <div class="inp-group"><input type="text" id="raceName" placeholder="Ime tekme"></div>
            <div class="inp-group"><input type="date" id="raceDate"></div>
            <div class="inp-group"><input type="number" id="raceDist" placeholder="Razdalja km"></div>
            <div class="modal-btns"><button class="btn" onclick="closeModal('addRaceModal')">Zapri</button><button class="btn" style="background:var(--green);color:white;" onclick="saveRace()">Dodaj</button></div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const YEAR = 2026; const MONTH = 0; const TODAY = new Date();
        const WEEKDAYS = ["NE", "PO", "TO", "SR", "ƒåE", "PE", "SO"];
        
        let appData = JSON.parse(localStorage.getItem('myRunnerData_v2')) || {};
        let userGoals = JSON.parse(localStorage.getItem('myRunnerGoals_v2')) || [];
        let myRaces = JSON.parse(localStorage.getItem('myRunnerRaces_v2')) || [];
        let settings = JSON.parse(localStorage.getItem('myRunnerSettings_v2')) || { subMonth: true, subWeek: true, viewMode: 'grid' };
        let editingKey = null; let editingGoalIndex = null;

        // --- FUNCTIONS (Definirane pred klicem) ---
        function forceSave() {
            localStorage.setItem('myRunnerData_v2', JSON.stringify(appData));
            localStorage.setItem('myRunnerGoals_v2', JSON.stringify(userGoals));
            localStorage.setItem('myRunnerRaces_v2', JSON.stringify(myRaces));
            localStorage.setItem('myRunnerSettings_v2', JSON.stringify(settings));
        }

        function toggleViewMode() { 
            settings.viewMode = settings.viewMode === 'grid' ? 'list' : 'grid'; 
            forceSave(); applyViewMode(); renderCalendar(); 
        }

        function applyViewMode() { 
            const wrap = document.getElementById('calendarWrap'); 
            const btn = document.getElementById('viewBtn'); 
            if(settings.viewMode === 'list') { wrap.className = 'calendar-wrap mode-list'; btn.innerText = 'üìÖ'; } 
            else { wrap.className = 'calendar-wrap mode-grid'; btn.innerText = 'üìú'; } 
        }

        function goTab(t) { 
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
            document.getElementById('tab-'+t).classList.add('active'); 
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(t === 'analytics') renderAnalytics();
        }

        function renderCalendar() {
            const body = document.getElementById('calendarBody'); body.innerHTML = '';
            let firstDay = new Date(YEAR, MONTH, 1).getDay(); let offset = (firstDay === 0 ? 6 : firstDay - 1);
            if(settings.viewMode === 'grid') {
                for(let i=0; i<offset; i++) { let d=document.createElement('div'); d.className='day-cell'; d.style.background='#fcfcfc'; body.appendChild(d); }
            }
            let sumY = 0, sumM = 0;
            for(let day=1; day<=31; day++) {
                let key = `${YEAR}-${MONTH+1}-${day}`;
                let entry = appData[key] || { type: 'run', run: 0, elev: 0 };
                let cell = document.createElement('div'); cell.className = 'day-cell';
                if(day === TODAY.getDate()) cell.classList.add('is-today');
                cell.onclick = () => openModal(day);
                
                let icon = entry.run > 0 && entry.type !== 'run' ? ACTIVITY_ICONS[entry.type] : '';
                
                if(settings.viewMode === 'grid') {
                    cell.innerHTML = `<div class="day-num">${day}</div><div class="dots-wrap"></div>`;
                    if(entry.run > 0) cell.querySelector('.dots-wrap').innerHTML = `<div class="dot-row">${icon}${entry.run}</div>`;
                    if(entry.elev > 0) cell.querySelector('.dots-wrap').innerHTML += `<div class="dot-row" style="color:var(--purple)">${entry.elev}m</div>`;
                } else {
                    let dDate = new Date(YEAR, MONTH, day);
                    cell.innerHTML = `<div class="day-left-col"><div class="day-num">${day}</div><div class="day-weekday">${WEEKDAYS[dDate.getDay()]}</div></div><div class="dots-wrap"></div>`;
                    if(entry.run > 0) cell.querySelector('.dots-wrap').innerHTML = `<div class="list-row">${icon} ${entry.run} km</div>`;
                    if(entry.elev > 0) cell.querySelector('.dots-wrap').innerHTML += `<div class="list-row" style="color:var(--purple)">‚õ∞Ô∏è ${entry.elev} m</div>`;
                }
                body.appendChild(cell);
                if(entry.type === 'run') { sumY += (entry.run || 0); sumM += (entry.run || 0); }
            }
        }

        function renderProgress() {
            const container = document.getElementById('progressSection'); container.innerHTML = '<div class="sec-title">NAPREDEK</div>';
            let stats = { runY: 0, runM: 0 };
            Object.keys(appData).forEach(k => {
                let v = appData[k]; if(!v.type || v.type === 'run') { stats.runY += (v.run||0); }
            });
            userGoals.forEach(g => {
                let cur = stats.runY; let avg = g.goal/365; let days = TODAY.getDate();
                container.innerHTML += `<div class="bar-group"><b>${g.name}</b><div class="bar-track"><div class="bar-fill" style="width:${Math.min(100, (cur/g.goal)*100)}%; background:${g.color}"></div></div></div>`;
            });
        }

        function renderAnalytics() {
            let maxD = 0, totalR = 0;
            Object.values(appData).forEach(v => { if(v.run > maxD) maxD = v.run; if(!v.type || v.type === 'run') totalR += v.run; });
            document.getElementById('statMaxDist').innerText = maxD + " km";
            document.getElementById('statTotalDist').innerText = totalR.toFixed(1) + " km";
        }

        function openModal(d) { editingKey = `${YEAR}-${MONTH+1}-${d}`; let v = appData[editingKey] || {run:'', elev:'', type:'run'}; document.getElementById('inpRun').value = v.run; document.getElementById('inpElev').value = v.elev; document.getElementById('entryModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function selectType(t, el) { document.getElementById('inpType').value = t; document.querySelectorAll('.type-opt').forEach(x => x.classList.remove('selected')); el.classList.add('selected'); }
        function saveData() { let r = parseFloat(document.getElementById('inpRun').value) || 0; let e = parseInt(document.getElementById('inpElev').value) || 0; if(r > 0 || e > 0) appData[editingKey] = {run:r, elev:e, type:document.getElementById('inpType').value}; else delete appData[editingKey]; forceSave(); closeModal('entryModal'); renderCalendar(); renderProgress(); }
        
        function openGoalModal() { document.getElementById('addGoalModal').style.display = 'flex'; }
        function saveGoalFromModal() { let n = document.getElementById('newGoalName').value; let t = parseFloat(document.getElementById('newGoalTarget').value); if(n && t) { userGoals.push({name:n, goal:t, color:document.getElementById('newGoalColor').value, unit:'km', type:'Letni', show:true}); forceSave(); closeModal('addGoalModal'); location.reload(); } }
        function renderSettings() { let s = document.getElementById('settingsList'); s.innerHTML = ''; userGoals.forEach((g,i) => { s.innerHTML += `<div class="goal-list-item"><span>${g.name}</span><button class="btn-delete" onclick="deleteGoal(${i})">üóëÔ∏è</button></div>`; }); }
        function deleteGoal(i) { userGoals.splice(i,1); forceSave(); location.reload(); }

        function downloadBackup() { 
            const b = JSON.stringify({data:appData, goals:userGoals, races:myRaces, settings:settings});
            const blob = new Blob([b], {type:'application/json'});
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'planer_backup.json'; a.click();
        }
        function handleFileUpload(input) {
            const reader = new FileReader(); reader.onload = (e) => {
                const b = JSON.parse(e.target.result); appData=b.data; userGoals=b.goals; myRaces=b.races; forceSave(); location.reload();
            }; reader.readAsText(input.files[0]);
        }

        // --- INIT ---
        window.onload = function() {
            applyViewMode();
            renderCalendar();
            renderProgress();
            renderSettings();
        };
    </script>
</body>
</html>
